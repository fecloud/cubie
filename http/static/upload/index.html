<!DOCTYPE html>

<html>

<head>

    <title>Take or select photo(s) and upload</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
    <meta name="format-detection" content="telephone=no">
    <style type="text/css">
        .progress-bar, .progress-bar b {
            display: block;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            border: solid 1px #aaaaaa;
        }

        .progress-bar b {
            background: #6CE26C;
            height: 8px;
            width: 0px;
            border: 0px;
            margin: 1px;
        }
    </style>
    <script type="text/javascript" src="/jquery-2.1.1.min.js"></script>
    <script type="text/javascript">

        function fileSelected() {

            var count = document.getElementById('upload').files.length;

            document.getElementById('details').innerHTML = "";

            for (var index = 0; index < count; index++) {

                var file = document.getElementById('upload').files[index];

                var fileSize = 0;

                if (file.size > 1024 * 1024)

                    fileSize = (Math.round(file.size * 100 / (1024 * 1024)) / 100).toString() + 'MB';

                else

                    fileSize = (Math.round(file.size * 100 / 1024) / 100).toString() + 'KB';

                document.getElementById('details').innerHTML += 'Name: ' + file.name + '<br>Size: ' + fileSize + '<br>Type: ' + file.type;

                document.getElementById('details').innerHTML += '<p>';

            }

            uploadFile();

        }

        function uploadFile() {

//            var fd = new FormData(document.forms.namedItem('form1'));

            var fd = new FormData();
            var count = document.getElementById('upload').files.length;

            var files = [];
            for (var index = 0; index < count; index++) {

                var file = document.getElementById('upload').files[index];
                var filename = '';
                if (file.name == "image.jpg") {
                    filename = new Date().format("yyyy-MM-dd hh:mm:ss-") + index + '.jpg'
                } else {
                    filename = file.name;
                }
                fd.append(filename, file);
                files.push(filename);
            }

            var xhr = new XMLHttpRequest();

            xhr.upload.addEventListener("progress", uploadProgress, false);

            xhr.addEventListener("load", uploadComplete, false);

            xhr.addEventListener("error", uploadFailed, false);

            xhr.addEventListener("abort", uploadCanceled, false);

            xhr.open("POST", "a.php?action=upload&value=/&files=" + JSON.stringify(files));
            xhr.send(fd);
            $('.progress-bar b').width(0);
        }

        function uploadProgress(evt) {

            if (evt.lengthComputable) {

                var percentComplete = Math.round(evt.loaded * 100 / evt.total);

                document.getElementById('progress').innerHTML = percentComplete.toString() + '%';

                var h = $('.progress-bar').width();
                h = h / 100;
                $('.progress-bar b').width(h * parseFloat(percentComplete.toString()) - 2);
            }


            else {

                document.getElementById('progress').innerHTML = 'unable to compute';

            }

        }

        function uploadComplete(evt) {

            /* This event is raised when the server send back a response */
            var h = $('.progress-bar').width();
            console.log(h);
            $('.progress-bar b').width(h - 2);
            alert(evt.target.responseText);

        }

        function uploadFailed(evt) {

            alert("There was an error attempting to upload the file.");
            $('.progress-bar b').css({background: "red"});
        }

        function uploadCanceled(evt) {

            alert("The upload has been canceled by the user or the browser dropped the connection.");

        }

        Date.prototype.format = function (format) {
            var o = {
                "M+": this.getMonth() + 1, //month
                "d+": this.getDate(),    //day
                "h+": this.getHours(),   //hour
                "m+": this.getMinutes(), //minute
                "s+": this.getSeconds(), //second
                "q+": Math.floor((this.getMonth() + 3) / 3),  //quarter
                "S": this.getMilliseconds() //millisecond
            }
            if (/(y+)/.test(format)) format = format.replace(RegExp.$1,
                    (this.getFullYear() + "").substr(4 - RegExp.$1.length));
            for (var k in o)if (new RegExp("(" + k + ")").test(format))
                format = format.replace(RegExp.$1,
                                RegExp.$1.length == 1 ? o[k] :
                                ("00" + o[k]).substr(("" + o[k]).length));
            return format;
        }

    </script>

</head>

<body>

<form id="form1" enctype="multipart/form-data" method="post" action="uploa.php?action=upload&value=/">

    <div>

        <label for="fileToUpload">Take or select photo(s)</label><br/>

        <input type="file" name="upload" id="upload" multiple="multiple" onchange="fileSelected();" accept="*/*"/>

    </div>

    <div id="details"></div>

    <div>

        <input type="button" onclick="uploadFile()" value="Upload"/>

    </div>

    <div id="progress"></div>
    <div>

        <span class="progress-bar"><b> </b></span>
    </div>
</form>

</body>

</html>