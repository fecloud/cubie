<!DOCTYPE html>
<html>
<head>
    <title>添加帐号</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
    <meta name="viewport"
          content="width=device-width,initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui"/>
    <link rel="apple-touch-icon-precomposed" href="/img/screen_icon.png"/>
    <meta name="format-detection" content="telephone=no"/>
    <link rel="stylesheet" href="../css/com.css"/>
    <link rel="stylesheet" href="../css/status.css"/>
    <script type="text/javascript" src="../js/jquery-2.1.1.min.js"></script>
    <script type="text/javascript" src="../js/jquery.cookie.js"></script>
    <script type="text/javascript" src="../js/com.js"></script>
    <style type="text/css">

        .list-item-input {
            text-align: right;
            border: none;
            width: 100%;
            height: 100%;
            padding: 0px;
            font-size: 18px;
            color: #8e8e93;
        }

        .waring {
            cursor: pointer;
            color: red;
        }


    </style>
    <script type="text/javascript">

        $(document).ready(function () {

            back_bind('index.html');


            $.ajax({url: baidupansync + parseInt(Math.random() * 10000000) + '.php?action=get_authorization_url&value=/&token=' + $.cookie('token'), success: function (data) {

                var address = data.data;
                $('#authorization').href = address;

            }});

            $('#code').bind('keypress', function (event) {

                if (event.keyCode == "13") {
                    start_add();
                }
            });

            //点击添加
            $('#add_account').bind('click', function () {
                start_add();
            });

        });

        function start_add() {
            var code = $('#code').val().trim();
            if (code != '') {

                $.ajax({url: baidupansync + parseInt(Math.random() * 10000000) + '.php?action=get_user_access_token&value=' + code + "&token=" + $.cookie('token'),
                    success: function (data) {

                        var baidu = data.data;
                        console.log(baidu);
                        if (baidu.error != undefined) {
                            add_fail();
                        } else {
                            var token = $.parseJSON(baidu);
                            if (token.error) {
                                //百度返回错误
                                add_fail();
                            } else {
                                add_account(token);
                            }

                        }

                    }, error: function () {

                        add_fail(false);

                    }});
            }
        }

        function add_fail(clear) {
            if (clear == undefined || clear) {
                $('#code').val("");
            }
            alert("添加失败,请重试!");
        }

        function add_account(baidu_access_token) {

            $.ajax({url: baidupansync + parseInt(Math.random() * 10000000) + '.php?action=add_user&value=' + JSON.stringify(baidu_access_token)+ "&token=" + $.cookie('token'),
                success: function (data) {

                    var userinfo_str = data.data;
                    if (undefined != userinfo_str) {

                        var userinfo = JSON.parse(userinfo_str);
                        if (undefined != userinfo && userinfo.uname) {

                            alert("[" + userinfo.uname + "]添加成功");
                            window.location.replace('index.html');

                        } else {
                            add_fail(false);
                        }

                    } else {
                        add_fail(false);
                    }


                }, error: function () {

                    add_fail(false);

                }});

        }


    </script>

</head>

<body>

<div id="page">

    <div id="header">

        <div class="btn back_btn">返回</div>
        <h1>添加帐号</h1>

        <div class="btn" id="add_account">添加</div>

    </div>

    <ul id="content" class="list group">

        <li class="list-item"><a id="authorization"
                                 href="https://openapi.baidu.com/oauth/2.0/authorize?response_type=code&client_id=riDL6RfoGHR7j1SrHtZmEqsj&redirect_uri=oob&&scope=basic%20netdisk&display=mobile"
                                 target="_blank">
            <div class="nobox waring">
                <div class="content">授权</div>
                <div class="box1 content text_right">
                    点击登录百度帐号
                </div>
            </div>
        </a>

        </li>

    </ul>


    <ul id="content" class="list group">

        <li class="list-item">
            <div class="nobox waring">
                <div class="content " style="margin-right: 19px">授权码</div>
                <div class="box1 content text_right">
                    <input id="code" placeholder="百度授权码" type="text" class="list-item-input waring"/>
                </div>

            </div>
        </li>

    </ul>


</div>

</body>
</html>